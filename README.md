Reactome Release QA Pipeline
============================
Consolidates all Reactome release QA checks.

Build
-----
1. Pull the following GitHub repositories:

   - [CuratorTool](https://github.com/reactome/CuratorTool.git)
   - [graph-importer](https://github.com/reactome/graph-importer.git)
   - [graph-qa](https://github.com/reactome/graph-qa.git)
   - [diagram-converter](https://github.com/reactome/diagram-converter.git)
   - [release-qa](https://github.com/reactome/release-qa.git)

   Place the `reactome` repository directory
   under a parent directory.

   _Note_: As of May 2018, some repository locations will change in
   the near future.

2. For Maven-based projects, cd to that project and build the package:

       mvn clean package -U

   However, see the _Note_ below to work around a `graph-importer` bug.

3. cd to `release-qa-pipeline` and run `build.sh`.

_Note_: As of May 2018 and for many months preceding, `graph-importer`
and `graph-qa` depend on a non-existent `graph-core` version.
`graph-core` is frequently modified and seldom deployed to the EBI
Maven repository. The following work-around is recommended:

1. Run `git pull` on `graph-core` and `graph-importer`.

2. cd to `graph-core` and run `mvn clean install -U`.

3. cd to `graph-importer` and change `pom.xml` to depend on the
   `graph-core` just installed.

3. cd to `graph-qa` and change `pom.xml` to depend on the
   `graph-core` just installed.

_Note_: `CuratorTool` must be refreshed manually in Eclipse after
running `git pull` before rebuilding `release-qa-pipeline`.

_Note_: The `release-qa-pipeline` `create-jar.xml` definitions are
generated by Eclipse export on the respective source projects.
If dependencies in those projects change, then the `create-jar.xml`
definition will be invalid and must be updated.

However, `create-jar.xml` cannot be simply regenerated directly by
Eclipse export and checked in, since the export is valid only for
the current Eclipse environment and user context. You can either
use the Eclipse export directly and not check in a modified
`create-jar.xml`, or adjust `create-jar.xml` manually for the
changed dependencies.

After the preceding work-arounds, the `release-qa-pipeline` dependent
repositories can be refreshed from the project directory as follows:

    (cd ../CuratorTool; git pull)
    (cd ../graph-importer; git pull; mvn clean package -U)
    (cd ../graph-qa; git pull; mvn clean package -U)
    (cd ../../reactome-pwp/diagram-converter; git pull; mvn clean package -U)
    (cd ../release-qa; git pull; mvn clean package -U)

Following these steps, `build.sh` can be run to refresh the
`dist/release-qa-pipeline.tar.gz` deployment bundle.

Deployment
----------

1. Copy `dist/release-qa-pipeline.tar.gz` to the release
   staging server and decompress it at
   `/usr/local/reactomes/Reactome/release-qa`.

2. Relax permissions:

   cd /usr/local/reactomes/Reactome/release-qa
   find . -type f | grep -v jar | xargs chmod a+w
   find . -type d | xargs chmod a+w

Usage
-----
cd to each `/usr/local/reactomes/Reactome/release-qa`
subdirectory and display the `*.sh` help to discover the
options,
e.g.:

    cd graph
    ./import.sh --help

The procedure below assumes that you will replace the server
graph database. You will need `sudo` permission to stop and
start Neo4j.

Run the scripts as follows:

1. cd to `/usr/local/reactomes/Reactome/release-qa`.

11. cd to the `curator` subdirectory.

12. Adjust the resources `.txt` files if necessary.

13. Execute `run.sh [options]`.

14. Examine the QA results in the `QA_Output` subdirectory.

21. cd to the `../slice` subdirectory.

22. Execute `run.sh [options]`.

23. Examine the QA results in the `output` subdirectory.

31. cd to the `../graph` subdirectory.

32. Execute `import.sh [options]`.

33. Reset the Neo4j database:

        sudo systemctl stop neo4j
        (cd /var/lib/neo4j/data/databases/;
         [ -d graph.db.old ] && sudo rm -r graph.db.old;
         [ -d graph.db ] && sudo mv graph.db graph.db.old;
         sudo cp -r /usr/local/reactomes/Reactome/release-qa/graph/data/databases/graph.db .;
         sudo chown -R neo4j:adm graph.db)
        sudo systemctl start neo4j

34. Execute `qa.sh [options]`.

35. Examine the QA results in the `output` subdirectory.

41. cd to the `../diagram` subdirectory.

42. Execute `run.sh [options]`.

43. Examine the QA results in the `output` subdirectory.
